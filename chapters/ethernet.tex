\chapter{Ethernet}
\label{sec:ethernet}

In \vref{sec:arp} hadden we gezien hoe een computer het destination MAC-adres bekomt als hij een frame wilt versturen over het netwerk.
In dit hoofdstuk leren we hoe switches deze frames naar hun bestemming sturen en welke gevaren er schuil gaan in een netwerk op laag~2.

\subsection{De werking van Ethernet}


\begin{figure}[hbp]
    \centering
    \includegraphics[width=\textwidth]{images/Ethernet_frame.png}
    \caption{An Ethernet frame inside an Ethernet packet, with SFD marking the end of the packet preamble and indicating the beginning of the frame}
    \label{fig:ethernet-frame}
\end{figure}


\Vref{fig:ethernet-frame} toont de velden in een Ethernet frame.
Eerst komen de \emph{preamble} en de \emph{start of frame delimiter} (SFD).
Deze dienen om het kloksignaal van de ontvanger af te stemmen op het kloksignaal van de zender zodat beide machines weten hoe lang het signaal van een 0 of een 1 duurt.

Hierna begint het eigenlijke Ethernet frame met het destination MAC-adres, gevolgd door het MAC-adres van de zender.
De \emph{EtherType} vertelt de ontvanger wat voor data er wordt verstuurd.
Enkele voorbeelden van geldige EtherTypes worden gegeven in \vref{tab:ethertype}.
Hierna komt de eigenlijke data of de \emph{payload} en ten slotte komt de \emph{frame check sequence} (FCS).
Dit is een code die gebruikt wordt om te detecteren of er fouten in het frame zitten.
Als het frame corrupt is, wordt deze gewoon verwijderd.
De ontvanger verwittigt de zender van het frame niet dat het frame niet goed is aangekomen.

\begin{table}[htp]
    \centering
    \begin{tabular}{ll}
    \textit{EtherType} & \textit{protocol} \\[1ex]
    0x0800 & IPv4 \\
    0x0806 & address resolution protocol (ARP) \\
    0x8100 & VLAN-tagged frame \\
    0x86DD & IPv6 \\
    \end{tabular}
    \caption{Enkele mogelijke waarden van de EtherType in een Ethernet frame}
    \label{tab:ethertype}
\end{table}


\section{Ethernetswitches}

Een Ethernetswitch ziet er niet anders uit dan een hub.
Een hub werkt echter heel anders dan een switch.
De interfaces van een hub zijn rechtstreeks met elkaar verbonden door middel van koperdraadjes zodat een elektrisch signaal dat binnenkomt op een van de interfaces, doorgestuurd wordt naar alle andere interfaces van de hub.
Een hub bevat geen intelligentie en kan niet geconfigureerd worden.

Een switch daarentegen is een toestel met heel wat intelligentie.
Er bestaan twee soorten switches: \emph{managed} en \emph{unmanaged} switches.
Unmanaged switches hebben de nodige intelligentie maar kunnen verder niet geconfigureerd worden.
Managed switches daarentegen beschikken over een volledig besturingssysteem en kunnen over zeer veel geavanceerde features beschikken.

\Vref{fig:ethernetswitch} toont een Juniper switch met 48~poorten of interfaces.
Rechts onder de display bevinden zich nog vier ``gaten'' in de switch.
Dit zijn sloten waar SFP-modules geplaatst kunnen worden (zie \vref{sec:sfp-modules}).

\begin{figure}
    \centering
    \includegraphics[width=\textwidth]{images/ethernetswitch.jpg}
    \caption{Een Ethernetswitch met 48 poorten en 4 openingen voor SFP-modules}
    \label{fig:ethernetswitch}
\end{figure}


In \vref{fig:simple-lan} zijn drie computers met elkaar verbonden via een switch.
Computer~1 wil communiceren met computer~2.
We gaan er even van uit dat beide computers elkaars IP-adres en MAC-adres kennen.
Als de switch de eerste frame ontvangt van computer~1, weet het nog niets over het netwerk of de toestellen die verbonden zijn met de switch, dus stuurt het het frame via alle interfaces naar buiten.
Computers~2 en~3 ontvangen dus dit eerste frame.
Computer~3 ziet het destination MAC-adres van het frame en, omdat dit niet zijn MAC-adres is, gooit het frame weg.
Computer~2 herkent wel zijn eigen MAC-adres in het frame en verwerkt de inhoud en stuurt uiteindelijk een antwoord terug.

De switch stuurt niet alleen het frame aan alle interfaces naar buiten, maar maakt ook notitie van het source MAC-adres en noteert dit in de MAC-tabel samen met de interface waarop hij het MAC-adres geleerd heeft.
\begin{center}
\begin{tabular}{cc}
\textit{MAC-adres} & \textit{interface} \\[1ex]
0200.aaaa.0001 & fa0/1\\
\end{tabular}
\end{center}
Als computer~2 nu een antwoord stuurt naar computer~1, komt dit frame aan op fa0/2 van de switch.
Weer noteert de switch het source MAC-adres in de MAC-tabel samen met de interface waarop de switch het frame ontvangt.
Vervolgens zoekt de switch het destination MAC-adres op in de MAC-tabel, vindt de bijhorende interface, en verstuurt het frame enkel langs deze interface naar buiten.
Computer~3 ziet dit antwoord -- en alle verder communicatie tussen computers~1 en~2 -- niet meer.

\begin{figure}
    \centering
    \input{drawings/simple-lan}
    \caption{Een eenvoudig netwerk met twee computers die met elkaar verbonden zijn via een switch}
    \label{fig:simple-lan}
\end{figure}

Een MAC-adres kan slechts aan één interface gekoppeld zijn.
Als de switch een MAC-adres dat het al kent, opnieuw leert via een andere interface, dan update het de bestaande entry in de MAC-tabel door de oude interface te vervangen door de nieuwe interface.

Het is wel mogelijk dat meerdere MAC-adressen op dezelfde interface geleerd worden.
Dit is mogelijk als een computer met meerdere virtuele machines, verbonden wordt met de switch.
Elke virtuele machine heeft immers een eigen MAC-adres.
Het is ook mogelijk meerdere MAC-adressen te leren op een interface als deze interface met een andere switch verbindt.
De eerste switch leert dan de MAC-adressen van alle computers die verbinden met de tweede switch via deze interface.


\section{Lussen in het netwerk}
\label{sec:stp}

Als één switch niet meer voldoende is om alle computers en printers met elkaar te verbinden, verbinden we een tweede switch met de eerste switch.
Als beide switch niet meer voldoende zijn, kunnen we nog een derde switch verbinden met het netwerk, en vervolgens nog een vierde en vijfde switch (zie \vref{fig:daisy-chain}).
Een dergelijk netwerk kan lang goed functioneren.
Tot op een dag bijvoorbeeld switch~2 kapot gaat en alle computers die met switches~3 tot en met~5 verbonden zijn, geen Internetconnectiviteit meer hebben.
Maar dit is eenvoudig op te lossen.
We verbinden switch~1 snel met switch~3 en de connectiviteit is hersteld.


\begin{figure}
    \centering
    \input{drawings/daisy-chain}
    \caption{Meerdere switches worden met elkaar verbonden in een lange lijn. Dit noemt \emph{daisy chaining}.}
    \label{fig:daisy-chain}
\end{figure}


Dit brengt echter een groot gevaar met zich mee.
Zolang switch~2 defect blijft, is er niets aan de hand.
Maar zodra switch~2 vervangen wordt door een nieuwe switch, hebben we een lus gemaakt in het netwerk.
Switch~1 verbindt met switch~2, zo met switch~3 en dan opnieuw naar switch~1.
Dit lijkt onschadelijk maar is dat zeker niet.

Neem opnieuw een computer verbonden met switch~1.
Deze wil met een andere computer in het netwerk communiceren.
De MAC-tabellen van alle drie de switches zijn leeg.
Als het eerste frame van de computer aankomt op switch~1, kan deze het source MAC-adres invullen zijn MAC-tabel maar omdat hij het destination MAC-adres niet kent, stuurt hij het frame via alle interfaces naar buiten.
Dit frame komt dus zowel bij switch~2 als bij switch~3 aan.
Switch~2 heeft ook een lege MAC-tabel dus stuurt het frame ook aan alle interfaces naar buiten, dus ook naar switch~3.

Switch~3 ontvangt het frame dus twee keer, een keer van switch~1 en een keer van switch~2.
Omdat het destination MAC-adres nog altijd niet bekend is, stuurt de switch beide frames langs alle interfaces naar buiten.
Switch~3 stuurt het frame dat hij van switch~2 gekregen heeft, door naar switch~1 en stuurt het frame van switch~1 door naar switch~2.

Eén frame heeft zich via deze lus verdubbeld en deze twee frames blijven rondlussen in het netwerk.
Dit soort fysieke lussen in het netwerk, kunnen een netwerk snel op de knieën brengen.



\section{Spanning-tree protocol (STP)}
Deze fysieke lussen zijn goed.
Als een switch of kabel kapot gaat, hebben de computers nog steeds netwerkconnectiviteit via de andere route.
Maar door de manier waarop switches omgaan met BUM-verkeer (broadcast, unknown unicast, multicast -- voor deze drie types heeft een switch nooit het destination MAC-adres in de MAC-tabel) zijn deze fysieke lussen net schadelijk voor je netwerk.
Het \emph{spanning-tree protocol} (STP) is een protocol dat deze fysieke lussen detecteert en telkens één interface in de lus uitschakelt.
Op die manier is het gevaar geweken want de frames kunnen niet meer eindelijk rondjes blijven draaien in de lus.
Als er echter een switch of kabel kapot gaat, wordt dit gedetecteerd door STP en wordt de interface die werd uitgezet, terug aangezet.

Spanning-tree protocol doet dit met behulp van \emph{bridge protocol data units} (BPDU),%
    \footnote{%
        De term ``bridge'' is een oude term voor ``switch.''
        Er waren enkele technische verschillen tussen beide soorten toestellen maar nu kunnen beide termen door elkaar gebruikt worden.%
        In de technische documentatie rondom STP wordt nog steeds bijna uitsluitend de term ``bridge'' gebruikt.
    }
speciale frames die switches naar elkaar sturen om informatie uit te wisselen over de status van het netwerk.
STP doorloopt vier stappen om een \emph{loop-free network} te bekomen.
\begin{enumerate}
\item
    Beslis samen welke switch de \emph{root bridge} wordt van het netwerk.
    Deze switch is als het ware de baas en verstuurt de BPDU's waarop de andere switches hun keuzes baseren.
    We kunnen de root bridge ook zien als de stam van de boom waar alle andere switches en verbindingen van aftakken.
\item
    Elke switch bepaalt de kortste route naar de root bridge en markeert deze interface als de \emph{root port}.
\item
    Elke link (kabel die twee switches met elkaar verbindt) heeft één \emph{designated port}.
    Als een van beide uiteindes al een root port is, moet de andere kant de designated port zijn.
    Als geen van beide uiteindes de root port is, wordt op basis van een selectiecriterium bepaald welk van de twee de designated port wordt.
\item
    Elke interface die geen root port of designated port is, wordt uit gezet.
    Op deze manier worden alle lussen in het netwerk verbroken.
\end{enumerate}

In stappen~1 en~3 moeten de switches een keuze maken.
Deze wordt gemaakt op basis van de volgende criteria.

LALALA NOT COMPLETE TODO


\section{Virtuele switches}


\section{Virtuele kabels}

% Ik heb geen idee wat ik bedoelde met virtuele kabels...