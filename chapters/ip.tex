\Chapter{Internet Protocol}
\label{chap:ip}

\Section{\acs{IP} addresses}
\label{sec:ip-address}
   
\Paragraph{32 bits}
\mode<article>{
To a computer an \acs{IP} address is just a 32-bit number.
For example, the number \num{177540347} converts to binary as

\begin{center}
\lstinline{0000 1010}\quad\lstinline{1001 0101}\quad\lstinline{0000 1100}\quad\lstinline{1111 1011}
\end{center}     
}
\slide[\num{177540347}]{0000 1010 1001 0101 0000 1100 1111 1011}

\Paragraph{four octets}
\mode<article>{
   \index{octet}
To make this 32-bit number more manageable to humans, we group the 32 bits into four sets of eight bits, called \emph{octets}.%
\footnote{%
   Currently all bytes are also eight bits so the words octet and byte are interchangeable.
   However, the size of the byte has historically been hardware-dependent and no definitive standards existed that mandated the size.
   Sizes from 1~to~48 bits have been used.
   For example, the \abbr{PDP-7}, a predecessor of the \abbr{PDP-11}, was an 18-bit machine.\index{PDP-07@\abbr{PDP-7}}\index{PDP-11@\abbr{PDP-11}}
}
\begin{center}
$\underbrace{\mbox{\lstinline{0000 1010}}}_{\mbox{octet 1}}$\quad%
$\underbrace{\mbox{\lstinline{1001 0101}}}_{\mbox{octet 2}}$\quad%
$\underbrace{\mbox{\lstinline{0000 1100}}}_{\mbox{octet 3}}$\quad%
$\underbrace{\mbox{\lstinline{1111 1011}}}_{\mbox{octet 4}}$
\end{center} 
}

\Paragraph{dotted decimal}
\mode<article>{
   \index{dotted decimal}
We then convert these octets into decimal and separate the four octets with a dot.
This turns the number \num{117540347} into the more human-friendly format 10.149.12.251.
Because each decimal number is in fact an octet (eight bits), the biggest number is \texttt{1111 1111} or 255 in decimal.

We can state this a bit more mathematically.
Each bit has two possible values, 0 or 1.
Eight bits then give us $2^8 = 256$ possible combinations or the values from 0 to 255.
The format of an \acs{IP} address thus is $x_1.x_2.x_3.x_4$ with $x_i \in [0,255]$.

It is important to remember that these \acs{IP} addresses are still just numbers to the computer and thus one \acs{IP} address is either higher or lower than a second address.
If you add 1 to the address 10.149.12.251, you get the next address, being 10.149.12.252.
If you add 1 to the address 10.149.12.255, you get the address 10.149.13.0, and adding 1 to the \acs{IP} address 10.149.255.255 gives the address 10.150.0.0.
}
\slide{$2^8=256 \quad \Rightarrow x_i \in [0,255]$}

\Paragraph{hierarchy}
\mode<article>{
Similar to a street address, \acs{IP} addresses also have an hierarchy.
While a street address is structured as country, city, street, and house number, an \acs{IP} address is structured using \emph{supernetting}, \emph{subnetting}, and the division between the network and the host part.
}

\Paragraph{network part}
\mode<article>{
Each \acs{IP} address consists of two parts.
The first, left, part uniquely identifies the local network to which the address belongs.
This is the network part or \emph{network number}.%
   \index{network number}
All computers attached to the same local network need an \acs{IP} address with the same network number.
}

\Paragraph{host part}
\mode<article>{
The \emph{host identifier}%
   \index{host identifier}
is the second part, on the right of the network number, which uniquely identifies the node on the network.
}

\Paragraph{subnet mask}
\mode<article>{
   \index{subnet mask}
The subnet mask is also a 32-bit number consisting of two parts.
Starting from the left, there is a set of ones for the network part of the \acs{IP} address.
This is followed by a set of zeros for the host part.
For example, the subnet mask 255.255.255.0 consists of 24 ones followed by 8 zeros.
This means that the first 24 bits -- or first three octets -- indicate the network, while the last 8 bits are used to uniquely identify hosts within the network.
This means there can be up to $2^8=256$ hosts in the network.
}

\mode<article>{
A second example could be 255.255.255.192.
Converting these octets to binary gives us 26 consecutive ones followed by 6 zeros.
This means that the first 26~bits of the accompanying \acs{IP} address are the network number and the last six bits are the host identifier.
}

\Paragraph{network address}
\mode<article>{
   \index{network address}
Each network requires two special addresses that can not be assigned to hosts.
The first is the network address.
It is the first \acs{IP} address in the network, i.e.~the \acs{IP} address where the host part consists of only zeros.

Let's take the \acs{IP} address 198.51.100.13 as an example, using the subnet mask 255.255.255.0.
As there are 24~ones, the first 24~bits -- or three octets -- of the \acs{IP} address are the network number.
The last 8~bits of the subnet mask are zero so the last octet of the \acs{IP} address is the host identifier.
The network address is the very first (lowest) address using this network number.
In this example, the network address is 198.51.100.0; the first three bytes must be identical for it to be the same network.
The host part -- the last 8~bits -- must be all zeros to give the lowest possible address.
}

\Paragraph{broadcast address}
\mode<article>{
   \index{broadcast address}
The second special \acs{IP} address is the broadcast address.
It is the last \acs{IP} address in the network, i.e.~the \acs{IP} address where the host part consists of only ones.%
\footnote{Even though I was always told the first address is the network address and the last address is the broadcast address, in fact both the first and the last address once were used as the broadcast address for the network by \href{https://github.com/schoen/unicast-extensions/blob/master/LOWEST.md}{4.2BSD}, an operating system from 1983.}

To continue with the previous example, the broadcast address of this network would be 198.51.100.255.
Again the network number -- the first three octets -- must remain identical.
With the host part -- the last octet -- all binary ones, these eight ones give the decimal number~255.
}

\Paragraph{local broadcast address}
\mode<article>{
   \index{broadcast address!local}
Every network has its own broadcast address as the last \acs{IP} address in the range.
There is a second broadcast address, 255.255.255.255, which is a link-local broadcast address.
It can only be used to communicate on the local link as routers do not forward packets with this destination address onto other networks.
}

\Paragraph{default gateway}
\mode<article>{
   \index{default gateway}
The default gateway is not a special address.
It is just the \acs{IP} address of the router that connects your local network to the other networks.
Most of the time it is either the first \emph{available} \acs{IP} address in the network or the last.
But this is not a requirement and it can be any available address in the network.
}

\Paragraph{loopback address}
\mode<article>{
   \index{loopback address}
All \acs{IP} addresses starting with 127 are reserved for the loopback address.%
   \footnote{In \acs{IP} version~6 there is only a single loopback address, namely ::1 or 127 binary zeros followed by a single binary one.}
When communicating with the loopback address, the computer connects back to itself.
For example, a web designer could install a web server on his own laptop which serves the website he is developing.
He can limi the web server to only allow access from the loopback address so that he alone can see the website, not making it available to the rest of the network.

There are people in the industry who want to free up a large chunk of these addresses for public use and only keep the 127.0.0.0/16 range for loopback addresses.%
\footnote{See \href{https://github.com/schoen/unicast-extensions}{The \acs{IP} version~4 cleanup project} on GitHub.}
All other \acs{IP} addresses will become publicly available.
However, this might take a few more years to become a reality.
}

\Section{A bit of history}
\label{sec:ip-history}

\Paragraph[1980]{\abbr{N.H.H.H}}
\mode<article>{
At first there were only 256 networks (the first octet) and each network could contain over 16 million hosts (24~bits for the host identifier gives $2^{24}=16777216$ addresses for devices in that network).
With both the 0 and 255 network reserved, in reality only 254 networks can be used.
}

\Paragraph[1981]{classful addressing}
\mode<article>{
   \index{classful addressing}
As the internet community quickly realised 254 networks were not enough, they kept the networks that were already assigned to companies and created a new system based on classes.
The first octet of the \acs{IP} address determined that class of \acs{IP} address and the class determined the size of the network, i.e.~which part is used for the network and which part is used for the host address.
\Vref{tab:classful-addressing} shows the different classes, their subnet mask and the number of hosts per network.
An \acs{IP} address belongs to a certain class if the first octet falls into the given range.
For example, the \acs{IP} address 198.51.100.37 falls into the class~c range as $192\le198\le223$. Thus, the first three octets determine the network and the fourth octet identifies the host within the given network.
}
\newsavebox{\classful}
\savebox{\classful}{
   \sffamily
   \begin{tabular}{crllr}
   \textbf{class} & \textbf{range} & \textbf{format} & \textbf{subnet mask} & \textbf{\# addresses} \\[1ex]
   a & 0--127   & \abbr{N.H.H.H} & 255.0.0.0 & \num{16777216} \\
   b & 128--191 & \abbr{N.N.H.H} & 255.255.0.0 & \num{65536} \\
   c & 192--223 & \abbr{N.N.N.H} & 255.255.255.0 & \num{256} \\
   d & 224--239 & \textit{multicast} & -- & -- \\
   e & 240--255 & \textit{reserved} & -- & -- \\
   \end{tabular}
}
\mode<article>{
\begin{table}
   \caption{Classful addressing (1981)}
   \label{tab:classful-addressing}
   \centering
   \sffamily
   \usebox\classful
\end{table}
}
\mode<beamer>{
\begin{frame}
\begin{center}
\usebox\classful
\end{center}
\end{frame}
}
\mode<article>{
This can be gathered from the third (format) and fourth (subnet mask) columns.
The third column indicates that the first three octets indicate the network number~(\abbr{N}) while the fourth octet is the host identifier~(\abbr{H}).
The fourth column translates this into something the computer can use with an \abbr{AND} operation.
The subnet mask contains binary ones when the corresponding bits of the \acs{IP} address are used to indicate the network number.
The subnet mask contains binary zeros when those corresponding bits are used for the host identifier.

Note that the subnet mask did not exist when these classes were introduced.
The subnet mask only came to be with the concept of \emph{subnetting} but the mask is included in \cref{tab:classful-addressing} for completeness and reference.
}

\Paragraph[1985]{subnetting}
\mode<article>{
   \index{subnetting}
%A subnetwork or subnet is a logical subdivision of an \acs{IP} network.
%The practice of dividing a network into two or more networks is called subnetting.
%Computers that belong to the same subnet are addressed with an identical most-significant bit-group in their \acs{IP} addresses.
%This results in the logical division of an \acs{IP} address into two fields: the \emph{network number} or \emph{routing prefix} and the \emph{rest field} or \emph{host identifier}.
%The rest field is an identifier for a specific host or network interface.
Subnetting is the process of taking a block of \acs{IP} addresses from \vref{tab:classful-addressing} and dividing it into smaller blocks in order to prevent wasting \acs{IP} addresses.
For example, the network 14.0.0.0 belongs to class~a and thus has a subnet mask of 255.0.0.0.
\Cref{tab:classful-addressing} teaches us there are over 16~million \acs{IP} addresses in this network though there is no way anyway would want (or can) build a network this large.

This block of \acs{IP} addresses contains over 16~million addresses, starting wtih 14.0.0.0 and ending with 14.255.255.255.
}

\Paragraph[1992]{supernetting}
\mode<article>{
   \index{supernetting}
A supernetwork, or supernet, is an \acs{IP} network that is formed by combination of multiple networks (or subnets) into a larger network.
The new routing prefix for the combined network represents the constituent networks in a single routing table entry.
The process of forming a supernet is called supernetting, \emph{prefix aggregation}, \emph{route aggregation}, or \emph{route summarisation}.

This basically means that the classes from \vref{tab:classful-addressing} no longer exist.
Every network needs a subnet mask that can have anywhere from one to thirty two bits allocated to the network number.
See \vref{sec:subnetting} for the details.

Let's take a look at two examples.
In the first example, we group the networks 198.18.0.0/16 and 198.19.0.0/16 into the supernet 198.18.0.0/15.
The third row displays the subnet mask in binary format.

\begin{center}
\sffamily
\begin{tabular}{c|c@{\qquad}l}
\color{spot1} 1100 0110 . 0001 001\color{spot2} 0 & . 0000 0000 . 0000 0000 & 198.18.0.0/16 \\
\color{spot1} 1100 0110 . 0001 001\color{spot2} 1 & . 0000 0000 . 0000 0000 & 198.19.0.0/16 \\
\hline
1111 1111 . 1111 1111 & . 0000 0000 . 0000 0000 & 255.255.0.0 \\
1111 1111 . 1111 1110 & . 0000 0000 . 0000 0000 & 255.254.0.0 \\
\end{tabular}
\end{center}


We can clearly see that the two networks are unique as the sixteenth bit from the left (in \textcolor{spot2}{magenta}) is different for both networks.
We can also see that the first fifteen bits (in \textcolor{spot1}{some kind of green}) are identical for both networks.


With \emph{supernetting} you can group both networks using one network address.
Write down the identical bits in decimal.
This gives us 198.18.0.0.
Now create a custom subnet mask indicating how many bits are shared between both networks.
As there are fifteen bits shared, this gives us 255.\textbf{254}.0.0.

For the second example, take 198.19.0.0/16 and 198.20.0.0/16, displayed in bold in the table below.
When we want to combine both networks in a supernet, we must take together the identical bits on the left and turn all the hosts bits to zero (to make the network address).
There are only thirteen bits identical. The last three bits differ.
Thus this supernet would be 198.16.0.0 with a subnet mask of 255.248.0.0.
However, this supernet includes all the other networks as well, from 198.16.0.0 to 198.23.0.0 as all these networks share the same thirteen leftmost bits.


\begin{center}
\sffamily
\begin{tabular}{c|cl}
\color{spot1} 1100 0110 . 0001 0\color{spot2} 000 & . 0000 0000 . 0000 0000 & 198.16.0.0/16 \\
\color{spot1} 1100 0110 . 0001 0\color{spot2} 001 & . 0000 0000 . 0000 0000 & 198.17.0.0/16 \\
\color{spot1} 1100 0110 . 0001 0\color{spot2} 010 & . 0000 0000 . 0000 0000 & 198.18.0.0/16 \\
\bfseries\color{spot1} 1100 0110 . 0001 0\bfseries\color{spot2} 011 & \bfseries . 0000 0000 . 0000 0000 & \bfseries198.19.0.0/16 \\
\bfseries\color{spot1} 1100 0110 . 0001 0\bfseries\color{spot2} 100 & \bfseries . 0000 0000 . 0000 0000 & \bfseries 198.20.0.0/16 \\
\color{spot1} 1100 0110 . 0001 0\color{spot2} 101 & . 0000 0000 . 0000 0000 & 198.21.0.0/16 \\
\color{spot1} 1100 0110 . 0001 0\color{spot2} 110 & . 0000 0000 . 0000 0000 & 198.22.0.0/16 \\
\color{spot1} 1100 0110 . 0001 0\color{spot2} 111 & . 0000 0000 . 0000 0000 & 198.23.0.0/16 \\
\hline
1111 1111 . 1111 1111 & . 0000 0000 . 0000 0000 & 255.255.0.0 \\
1111 1111 . 1111 1000 & . 0000 0000 . 0000 0000 & 255.248.0.0 \\
\end{tabular}
\end{center}
}

\Paragraph[1993]{\acf{CIDR}}
\mode<article>{
   \iacs{CIDR}
\Acl{CIDR} is a method for allocating \acs{IP} addresses and for \acs{IP} routing.
The \gls{IETF} introduced \acs{CIDR} to replace the previous classful network addressing architecture on the internet.
Its goal was to slow the growth of routing tables on routers across the internet, and to help slow the rapid exhaustion of \acs{IP} version~4 addresses.
}

\Paragraph[1998]{\acs{IP} version 6}
\mode<article>{
   \index{IP version 6@\acs{IP} version~6}
\acs{IP} version~6 was developed by the \gls{IETF} to deal with the long-anticipated problem of \acs{IP} version~4 address exhaustion, and is intended to replace \acs{IP} version~4.
In December 1998, \acs{IP} version~6 became a draft standard for the \gls{IETF}, which subsequently ratified it as an internet standard on 14 July 2017.
}


\Section{Subnetting}
\label{sec:subnetting}

% TODO: at least attempt to explain subnetting

\newsavebox{\subnettingOne}
\savebox{\subnettingOne}{
\begin{tikzpicture}
   \draw[white] (0,-35mm) -- (0,35mm);
   \draw[white] (-56mm,0) -- (56mm,0);
   \pie[sum = auto,
         color = {
            spot1,
            spot1!66,
            spot2,
            spot3!20
         }
      ]{64/{\small 198.51.100.0/26},
         64/{\small 198.51.100.64/26},
         64/{\small 198.51.100.128/26},
         64/{\small 198.51.100.192/26}}
\end{tikzpicture}
}

\mode<article>{
\begin{figure}
   \centering
   \usebox\subnettingOne
   \caption[Dividing a block of \acs{IP} addresses in four equal parts]{With subnetting you can divide a block of 256~\acs{IP} addresses into four smaller blocks of 64~addresses each}
   \label{fig:subnetting}
\end{figure}
}

\mode<beamer>{
\begin{frame}
\begin{center}
\scalebox{.9}{\usebox\subnettingOne}
\end{center}
\end{frame}
}

\newsavebox{\subnettingTwo}
\savebox{\subnettingTwo}{
\begin{tikzpicture}
   \draw[white] (0,-35mm) -- (0,35mm);
   \draw[white] (-56mm,0) -- (56mm,0);
   \pie[sum = auto,
         color = {
            spot1,
            spot1!66,
            spot2,
            spot3!40,
            spot3!20
         }
      ]{64/{\small 198.51.100.0/26},
         64/{\small 198.51.100.64/26},
         32/{\small 198.51.100.128/27},
         32/{\small 198.51.100.160/27},
         64/{\small 198.51.100.192/26}}
\end{tikzpicture}
}

\mode<article>{
\begin{figure}
   \centering
   \usebox\subnettingTwo
   \caption[With \acs{VLSM} you can divide an \acs{IP} block in unequal parts]{When using \acfp{VLSM} you can further divide a subnet into smaller segments}
   \label{fig:vlsm}
\end{figure}
}
\mode<beamer>{
\begin{frame}
\begin{center}
\scalebox{.9}{\usebox\subnettingTwo}
\end{center}
\end{frame}
}


\Paragraph{prefix}
\mode<article>{
   \index{prefix}
The network prefix is the first part of the \acs{IP} address, identifying the network.
}

\Paragraph{prefix length}
\mode<article>{
   \index{prefix!length}
The prefix length is the size of the prefix in number of bits.
It translates directly to the subnet mask.
The prefix length is the number of ones in the subnet mask.
}


\Paragraph{Why do we need subnetting?}
\mode<article>{
   \index{subnetting}
We are the network administrators of a small company.
We have a couple (50) of desktop computers for the employees, as well as a few (10) servers.
We contact \acs{RIPE} \acs{NCC}%
    \footnote{\gls{RIPE} \gls{NCC} is the \gls{RIR} for Europe, the Middle East and parts of central Asia. As a \gls{RIR}, it oversees the allocation and registration of internet number resources such as \acs{IP} addresses and autonomous system numbers.}
and tell them we need sixty \acs{IP} addresses, plus some extra just in case we will grow and need more computers.
Since a class~c address range contains 256~\acs{IP} addresses, \gls{RIPE} will give us one such range, e.g.~198.51.100.0/24.%
   \iacs{RIPE}

Now we have a problem.
We have plenty of \acs{IP} addresses but we need two separate networks.
Or perhaps we need three or even four.
Maybe we want to isolate the public internet-facing servers from the private servers that should not be reachable from the internet.

Remember that these different classes are just made-up methods of determining which part of the \acs{IP} address is the network number and which part is the host identifier.
\acs{IP} addresses themselves are just 32-bit numbers so we can group them any way we like.
}


\Section{\acl{DHCP}}
\label{sec:dhcp}


\Paragraph{simplifies \acs{IP} address configuration}
\mode<article>{
   \iacs{DHCP}
Without the \gls{DHCP} you would have to contact a network administrator every morning at work when you power on your laptop and want to connect it to the (wireless) network.
Back at home or at a friend's place you need to change the \acs{IP} settings again, including which \acs{DNS} servers to use.
This requires huge lists with available \acs{IP} addresses which are being updated constantly with newly available \acs{IP} addresses -- should you remember to contact your network administrator before leaving work -- or available \acs{IP} addresses becoming unavailable as people come in to work every morning.
}

\Paragraph{\acs{DORA}}
\mode<article>{
   \index{DHCP@\acs{DHCP}!DORA@\acs{DORA}}
\gls{DHCP} operations fall into four phases: server discovery, \acs{IP} address lease offer, lease request, and lease acknowledgement.
These stages (see \vref{fig:dora}) are often abbreviated as \acs{DORA} for \acl{DORA}.

\begin{figure}
    \centering
    \input{images/dora.tex}
    \caption{The foure stages of acquiring an \acs{IP} address from a \acs{DHCP} server}
    \label{fig:dora}
\end{figure}
}
\mode<beamer>{
\begin{frame}
\begin{center}
\input{images/dora}
\end{center}
\end{frame}
}


\Paragraph{lease time}
\mode<article>{
   \index{DHCP@\acs{DHCP}!lease time}
When the server offers the client an \acs{IP} address, it does this for a specific lease time.
After this time expires, the client must relinquish the given \acs{IP} address.
To prevent the client from getting disconnected from the network while it requests a new \acs{IP} address, it can refresh the lease on its current \acs{IP} address midway the lease period.

For example, when the client gets an \acs{IP} address with a lease time of eight hours, it can refresh the lease period after four hours.
If the server grants this request, the lease is again valid for eight hours.

If the \acs{DHCP} server denies the request, the client loses the lease right away.
It cannot use the \acs{IP} address for the remaining four hours but must send a \acs{DHCP} discover message to request a new \acs{IP} address.
}

\Paragraph{\acs{DHCP} relay}
\mode<article>{
   \index{DHCP@\acs{DHCP}!relay}
As it is impractical to configure a \acs{DHCP} server on each network, routers can be configured to act as \acs{DHCP} relays, forwarding the broadcast messages as unicast to a remote \acs{DHCP} server.
}

\Paragraph{reservations}
A \acs{DHCP} server can be configured such to always provide the same client (\acs{MAC} address) the same \acs{IP} address.
This way the client practically has a fixed \acs{IP} address, as if configured manually on the device itself.
But you keep the \acs{IP} address configuration on a central location.

\Section{\Acl{NAT}}
\label{sec:nat}


\Paragraph{private \acs{IP} space}
\mode<article>{
There is nothing special about `private' \acs{IP} addresses.
   \index{IP address@\acs{IP} address!private}
   \index{IP address@\acs{IP} address!public}
   \index{internet}
   \iacs{ISP}
They are not treated any different from `public' \acs{IP} addresses by routers or end hosts.
The only difference is that they \emph{should} not be routed on the public internet.
This means that \acl{ISP} should block packets with a private \acs{IP} address as either the source or the destination address.

There are several blocks of private \acs{IP} addresses which can be used internally by organisations without having to ask for permission to do so.
These include:
\begin{multicols}{3}
\raggedcolumns
\begin{itemize}
\item 10.0.0.0/8
\item 169.254.0.0/16
\item 172.16.0.0/12
\item 192.168.0.0/16
\item 100.64.0.0/10
\item 192.0.2.0/24
\item 198.18.0.0/15
\item 198.51.100.0/24
\item 203.0.113.0/24
\end{itemize}
\end{multicols}

The address range 169.254.0.0/16 is a special case.
These are defined as `link-local' addresses which cannot be forwarded by a router.%
   \index{IP address@\acs{IP} address!link-local}
Microsoft uses these addresses as \acp{APIPA}.%
   \index{IP address@\acs{IP} address!APIPA@\acs{APIPA}}
A Windows computer takes a random \acs{IP} address from this range when it is configured to receive an \acs{IP} address from a \acs{DHCP} server but it receives no responses from any \acs{DHCP} server.
}

\Paragraph{port-based address translation}
\mode<article>{
   \iacs{NAT}
The majority of network address translators map multiple private hosts to one publicly exposed \acs{IP} address.
In a typical configuration, a local network uses one of the designated private \acs{IP} address subnets (\rfc{1918}).
A router in that network has a private address of that address space.
The router is also connected to the internet with a public address, typically assigned by an internet service provider.

As traffic passes from the local network to the internet, the source address in each packet is translated on the fly from a private address to the public address.
The router tracks basic data about each active connection (particularly the destination address and port).
When a reply returns to the router, it uses the connection tracking data it stored during the outbound phase to determine the private address on the internal network to which to forward the reply.

All \acs{IP} packets have a source \acs{IP} address and a destination \acs{IP} address.
Typically packets passing from the private network to the public network will have their source address modified, while packets passing from the public network back to the private network will have their destination address modified.
To avoid ambiguity in how replies are translated, further modifications to the packets are required.
For \acs{TCP} and \acs{UDP} the port numbers are changed so that the combination of \acs{IP} address and port number on the returned packet can be unambiguously mapped to the corresponding private network destination.
\rfc{2663} uses the term \gls{NAPT} for this type of \acs{NAT}.
Other names include \gls{PAT}, \acs{IP} \emph{masquerading}, \acs{NAT} \emph{overload} and \emph{many-to-one} \acs{NAT}.
This is the most common type of \acs{NAT} and has become synonymous with the term \acs{NAT} in common usage.
   \index{IP masquerading@\acs{IP} masquerading}
   \index{NAT@\acs{NAT}!overload}
   \index{NAT@\acs{NAT}!many-to-one}
   \iacs{PAT}
}

\Paragraph{pool of public addresses}
\mode<article>{
   \index{NAT@\acs{NAT}!pool}
It is possible to use multiple public \acs{IP} addresses to translate the private \acs{IP} address into.
When this is used in combination with port-based address translation, it allows for multiple thousands of private hosts to communicate on the internet.
}

\Paragraph{one-to-one translation}
\mode<article>{
   \index{NAT@\acs{NAT}!static}
   \index{NAT@\acs{NAT}!one-to-one}
This method is most often used to translate a range of private \acs{IP} addresses into a different range of private \acs{IP} addresses.
This is often needed when two companies with overlapping \acs{IP} address space connect their networks together.
}

\Section{Routing}
\label{sec:routing}

\Paragraph{What is a router?}
\mode<article>{
   \index{router}
   \index{packet!forwarding}
A router is really just a specialised computer that \emph{forwards} packets it receives but which are not destined for itself.
A computer can also be configured to function as a router by turning on this option (\vref{lst:freebsd-enable-routing,lst:rhel-enable-routing}).
}

\newsavebox{\lstrouterOne}
\newsavebox{\lstrouterTwo}
\begin{lrbox}{\lstrouterOne}
\begin{lstlisting}[caption={Enable routing on a FreeBSD host},label={lst:freebsd-enable-routing}]
# sysrc gateway_enable="YES"
# sysctl net.inet.ip.forwarding=1
\end{lstlisting}
\end{lrbox}
\begin{lrbox}{\lstrouterTwo}
\begin{lstlisting}[caption={Enable routing on a \acs{RHEL} host},label={lst:rhel-enable-routing}]
# echo "net.ipv44.ip_forward=1" >> /etc/sysctl.conf
# echo 1 > /proc/sys/net/ipv4/ip_forward
\end{lstlisting}
\end{lrbox}
\mode<article>{
\noindent
\usebox\lstrouterOne

\noindent
\usebox\lstrouterTwo

When a router receives a packet with a destination \acs{IP} address which does not belong to any of the router's interfaces, the router looks up the \acs{IP} address in its \emph{routing table} and forwards the packet out the given interface.%
   \index{routing table}
}
\newsavebox{\lstrouterThree}
\begin{lrbox}{\lstrouterThree}
\begin{lstlisting}[caption={The routing table on a linux machine},label={fig:routing-table}]
[doyle] ~ $ netstat -rn
Kernel \acs{IP} routing table
Destination     Gateway         Genmask         Iface
10.0.0.0        172.24.12.1     255.255.240.0   eth1
10.0.16.0       172.24.12.1     255.255.240.0   eth1
10.0.32.0       192.168.16.1    255.255.224.0   eth2
172.21.3.0      0.0.0.0         255.255.255.0   eth0
172.24.12.0     0.0.0.0         255.255.255.0   eth1
192.168.16.0    0.0.0.0         255.255.255.0   eth2
0.0.0.0         172.21.3.1      0.0.0.0         eth0
\end{lstlisting}
\end{lrbox}
\mode<article>{
\noindent
\usebox\lstrouterThree

Routers only know about the networks they directly connect to.
They must thus learn about distant networks.
This can happen in one of two ways, either the network administrator manually configures the router to forward a certain prefix to some other router (the \emph{next-hop} router) or the routers in a network can use a \emph{dynamic routing protocol} to teach each other about the networks they know and how to reach them.
   \index{router!next-hop}
}

\slide{routing table}
%\begin{frame}[fragile]
%\usebox\lstrouterThree
%\end{frame}

\Paragraph{\acl{TTL}}
\mode<article>{
   \iacs{TTL}
The \acs{IP} header contains a \gls{TTL} field which indicates how many routers (hops) it can pass before it must be deleted.
This prevents the data packet from circulating indefinitely.
As it is an 8-bit field, the maximum value is~255 but a recommended initial value is~64.\footnote{See \rfc{1700}, p.~64.}

As it does not really signify some time spent in transit, with the development of \acs{IP} version~6, they changed the name of this field to \emph{hop limit} as that is what it really does: limit the number of hops (routers) that a packet can travel.
}


\Paragraph{fragmentation}
\mode<article>{
   \index{fragmentation}
   \iacs{MTU}
Different physical media have different maximum frame sizes.
For example, Ethernet has a maximum frame size of 1518~bytes or a \gls{MTU} of 1500~bytes, which is the frame size minus the header length.
Token Ring has a much larger \gls{MTU} of 4464~bytes, \gls{ATM} and \abbr{X.25} have much smaller \acp{MTU} of 48~and 576~bytes respectively.

When a router connects an Ethernet segment to an \gls{ATM} circuit, it must \emph{fragment} the 1500-byte frames it receives into 48-byte cells that it can forward across the \ac{ATM} network.
Once fragmented, routers do not reassemble the pieces back together as they might take different paths through the network and are not guaranteed to arrive in the correct order.
The end host is responsible for piecing all fragments back together.

Another example when fragmentation is being used, is in the communication between a data centre and campus network as the former often uses jumbo frames (9000~bytes) while the latter uses normal Ethernet frames which have a maximum size of 1500~bytes.%
   \index{frame!jumbo}
   \index{data centre}

Finally, you will also encounter fragmentation on IPsec \aclp{VPN} where the maximum transmission unit is slightly smaller than the normal 1500~bytes.
   \index{VPN@\acs{VPN}!IPsec!fragmentation}
}

\Paragraph{broadcast domain}
\mode<article>{
   \index{broadcast domain}
A \emph{broadcast domain} is that part of the network to which a broadcast messages propagates.
One of the functions of a router is to stop broadcasts, not forwarding the to other parts of the network.
}

\Paragraph{static routing}
\mode<article>{
   \index{static routing}
Static routing is a form of routing that occurs when a router uses a manually-configured routing entry, rather than information from dynamic routing traffic.
In many cases, static routes are manually configured by a network administrator by adding in entries into a routing table, though this may not always be the case.
Unlike dynamic routing, static routes are fixed and do not change if the network is changed or reconfigured.
Static routing and dynamic routing are not mutually exclusive.
Both dynamic routing and static routing are usually used on a router to maximise routing efficiency and to provide backups in case dynamic routing information fails to be exchanged.
Static routing can also be used in \emph{stub networks},%
index{stub network}%
\footnote{%
A stub network is a (part of a) network with only one way to reach the rest of the network.
It thus does not need detailed knowledge about the network but can usually route all traffic using a single default route pointing to the exit point.
}
or to provide a gateway of last resort.
}


\Paragraph{dynamic routing protocols}
\mode<article>{
   \index{routing protocol!distance-vector}
   \index{routing protocol!link-state}
\begin{description}
\item[distance-vector]
A distance-vector routing protocol is like putting signposts on every crossroads with the router being the crossroads.
Every router learns about all networks but only the direction it has to send traffic to (the next-hop router) and the total distance to reach the remote network.
\item[link-state]
A link-state routing protocol is comparable to every router building a roadmap with all links interconnecting the different routers included.
Once the entire map has been drawn, each router can calculate the best path to reach each destination.
\end{description}
}
\slide{distance-vector}
\slide{link-state}

\Paragraph{metric}
\mode<article>{
   \index{metric}
When we take a look at \vref{fig:metric}, we see that router $R_4$ connects to the network 192.0.2.0/24.
It advertises this to routers $R_2$ and $R_3$ which in turn both advertise this network to router $R_1$.
Router $R_1$ now knows two paths to reach the destination network 192.0.2.0/24, once via $R_2$ and once via $R_3$.
For $R_1$ to decide which path is best, it compares the \emph{metric} of both paths; the lowest value is the best path.

When a router advertises a network, it includes a metric value.
When another router forwards this information -- e.g.~router $R_2$ forwards the information about network 192.0.2.0/24 to router $R_1$ -- it updates the metric value.

Every routing protocol can use a different metric.
\acs{RIP} uses a simple \emph{hop count} or the number of routers you have to traverse to reach your destination.
\acs{OSPF} and \acs{IS-IS} use a generic \emph{cost} value.
Most \acs{OSPF} implementation use a cost value based on the bandwidth of the links while with \acs{IS-IS} the network administrator has to manually set a cot value for each link.
\acs{EIGRP} uses a very complex formula to determine the metric, see \vref{eqn:eigrp-metric}.

\begin{figure}
   \centering
   \input{images/metric}
   \caption[The metric decides the best route in a network]{A router can learn a prefix from several other routers. The metric decides the best route.}
   \label{fig:metric}
\end{figure}
}

\Paragraph{administrative distance}
\mode<article>{
   \index{administrative distance}
The \emph{metric} indicates the preference of a single route learnt from different routers using the same routing protocol.
It is however also possible for a router to learn a route from different routing protocols.
The \emph{administrative distance} gives the preference or credibility of a routing protocol over another.
For example, on Cisco routers the administrative distance or credibility of \acs{RIP} is~110 while the administrative distance of \acs{OSPF} is~90.
As lower values are preferred, when a router running both \acs{RIP} and \acs{OSPF} learn about the same route from both protocols, it will prefer the route learnt from \acs{OSPF} over the route learnt from \acs{RIP}.
}

\Paragraph{\acf{RIP}}
\mode<article>{
The \acl{RIP} is an example of a distance-vector routing protocol using the \emph{hop count} or the number of routers to count how good a given path is.%
   \index{metric!hop count}
It is a very simple protocol useful in smaller networks.
The protocol is not suitable for larger networks because of its slow \emph{convergence time} and its tendency to propagate good information slowly and negative information quickly.
   \index{convergence time}
}

\Paragraph{route poisoning}
\mode<article>{
   \index{route poisoning}
% source: https://www.geeksforgeeks.org/route-poisoning-and-count-to-infinity-problem-in-routing/
The main issue with distance-vector routing protocols is routing loops.%
   \index{routing loop}
This routing loop in the network causes the count-to-infinity problem.%
   \index{count-to-infinity}
Routing loops usually occur when an interface goes down or two routers send updates at the same time.

Route poisoning helps to alleviate this problem by advertising the route back to its source with a metric of infinity.
This ensures that the router originally advertising the prefix can never use its neighbours to reach the given network.
}

\Paragraph{split horizon}
\mode<article>{
   \index{split horizon}
Split horizon is another method to prevent routing loops from occuring.%
   \index{routing loop}
This time, instead of advertising the routes back with a metric of infinity, we simple do not advertise the route back to where we learned it from.
This method is not as good as using route poisoning to prevent routing loops.
Logically you can not use both both methods. Either you use neither method, or you use one or the other.
}

\Paragraph{hold-down timer}
\mode<article>{
   \index{hold-down timer}
Hold down works by having each router start a timer when they first receive information about a network that is unreachable.
Until the timer expires, the router will discard any subsequent route messages that indicate the route is in fact reachable.
It can solve the case where multiple routers are connected indirectly.
There are realistic scenarios where split horizon and split horizon with poisoned reverse can do nothing.
}

\Paragraph{\acf{EIGRP}}
\mode<article>{
   \iacs{EIGRP}
The \acl{EIGRP} was a Cisco proprietary protocol which has been made publicly available in 2013 but has not been implemented by other vendors.

While \acs{RIP} and \acs{OSPF} have a very simple metric, \acs{EIGRP} has a rather complex one.
The metric $m$ is calculated as such:
\begin{equation}
m = \left[\left(k_1 B_m  + k_2 \frac{B_m}{256-L} + k_3 D_s\right) \times \frac{k_5}{k_4 + R}\right] \times 256,
\label{eqn:eigrp-metric}
\end{equation}
with $B_m$ being the minimum bandwidth along the path to the destination, $D_s$ being the total delay along the path, $L$ and $R$ being the load an the reliability of the link respectively, taken over a five-minute interval.
The five $k$ values are user-configurable weights to each part of the equation.

As if \cref{eqn:eigrp-metric} is not complex enough, there are a few important caveats.
The minimum bandwidth $B_m$ is calculated by dividing a reference bandwidth of \SI{1e7}{\bit\per\second} by the smallest configured bandwidth on the interfaces along the path.
It does not take into account the actual bandwidth of an interface, but the setting configured on the interface.

The total delay also is not measured along the path but fixed values are used depending on the interface type.
A serial interface always has a default delay of \SI{20000}{\micro\second} while a Gigabit Ethernet interface has a default delay of \SI{10}{\micro\second}, regardless of the length of the cable.
Both settings are user configurable.

If load an reliability are used in the computation -- which by default they are not -- the initial values are set during peer establishment and do not change dynamically with the router.
These values are a remnant of an older version of the protocol where they did change with every update to reflect the live status of the network.

Finally, when $k_5=0$, instead of the entire equation to become zero, this factor is removed from the equation.
}

\Paragraph{\acf{OSPF}}
\mode<article>{
   \iacs{OSPF}
The \acl{OSPF} protocol is a link-state routing protocol suitable for small network all the way up to massive service provider networks.
It can scale to very large networks because of the introduction of a concept called \emph{areas}, used to divide the entire network into smaller, more manageable parts.
% TODO: expand on this paragraph
}

\Paragraph{\acf{BGP}}
\mode<article>{
   \iacs{BGP}
   \index{routing protocol!path-vector}
   \index{autonomous system}
The \acl{BGP} is neither a distance-vector nor a link-state routing protocol.
It is the only \emph{path-vector} routing protocol and it is used to interconnect different \emph{autonomous systems}, meaning it can be used to interconnect networks operated by different organisations.
A basic \acs{BGP} configuration is relatively simple but it can quickly become extremely complex.

Contrary to normal routing protocols which serve to make all networks known within the entire internetwork, \acs{BGP} aims to limit reachability and focusses on \emph{policies}.
You can tweak the protocol so that you can exactly control the path a packet has to travel through the network to reach its destination.
}


\mode<article>{
\section{Further reading}
\textcite{lammle-ccna,lammle-comptia} are both good reasons to continue from here.
They both explain \acs{IP} addresses, subnetting, \acs{DHCP}, and routing in more detail.
Another great resource is \textcite{stevens} but this masterpiece is probably a bit too in-depth.
\textcite{doyle} is another classic focussing on routing protocols such as \acs{RIP}, \acs{OSPF}, and \acs{IS-IS} while the second volume covers \acs{BGP}.
}
