\chapter{Routing}
\label{sec:routing}

A \emph{router} connects multiple networks together.
\Vref{fig:routing-basic} shows a router in\-ter\-con\-nect\-ing two networks.
When a host of one network wants to communicate with a host on the other network, it can send the traffic to the router.
The router can forward the traffic on to the other network.
Things are easy for this router as there are only two networks and the router knows about both of them as it has an interface in each network.


\begin{figure}
   \centering
   A ROUTER CONNECTING TWO NETWORKS TOGETHER
   \caption{A router connecting two networks together}
   \label{fig:routing-basic}
\end{figure}

Things become a bit more complex in \vref{fig:routing-two-routers}.
Router \hostname{blue} knows about three of the four networks as it has an interface in these three networks.
Router \hostname{red} only knows about two of the four networks.
For \hostname{blue} to be able to send traffic to the fourth network, we must teach \hostname{blue} how to reach this network.
In this case, things are relatively easy: we can tell \hostname{blue} to forward all traffic destined to this fourth network to \hostname{red}, who already knows about this network.
Similarly we need to teach \hostname{red} how to reach the two networks that it does not know about.


\begin{figure}
   \centering
   \caption{Two routers interconnecting a total of four networks}
   \label{fig:routing-two-routers}
\end{figure}


We could manually configure both \hostname{blue} and \hostname{red} but this is tiresome, repetitive work, error-prone and static.
It does not react well to changes in the network, for example, when a link fails or gets added.
The industry thus developed several protocols for the routers to exchange this information dynamically.
Each routers tells their neighbouring routers the networks it knows about.
This wasy, eventually all routers learn about all networks and they can calculate the best path to reach each network.

In this chapter will first consider static routing in more detail.
Next we will discuss the Routing Information Protocol, a simple yet still widely used protocol for dynamically exchanging network prefixes.
We conclude the chapter with a brief introduction to both Open Shortest Path First and the Border Gateway Protocol.



\section{The router's routing table}

Every host which has an \abbr{IP} address, also has a routing table which tells the device how to forward traffic.
Depending on your operating system you can view the local routing table with \cmd{netstat} or \cmd{route}.
Below is an example for a server running FreeBSD version 13.0-\textsc{release}-p8.
\begin{verbatim}
$ netstat -rnf inet
Routing tables

Internet:
Destination        Gateway            Flags     Netif Expire
default            198.19.208.1       UGS      vtnet0
10.18.0.0/16       link#1             U        vtnet0
10.18.0.5          link#1             UHS         lo0
10.133.0.0/16      link#2             U        vtnet1
10.133.19.35       link#2             UHS         lo0
127.0.0.1          link#3             UH          lo0
198.19.208.0/21    link#1             U        vtnet0
198.19.210.27      link#1             UHS         lo0
\end{verbatim}
I have given three flags to the command.
The first flag (``-r'') tells \cmd{netstat} to list the routing tables.
The second flag (``-n'') tells \cmd{netstat} to not resolve hostnames.
Omitting this flag results in ``127.0.0.1'' being shown as ``localhost'' and ``198.19.210.27'' -- which is this host's local IP address -- to be replaced by the hostname of this host.
The third and final option (``-f inet'') makes \cmd{netstat} only display the \abbr{IP} version~4 or \emph{inet4} routing table.

The first column lists the prefix and prefix length with the exception of a \emph{host route} or single \abbr{IP} address, which has a prefix length of 32 bits, and the default route.
The world ``default'' means ``0.0.0.0/0'' or ``no bits have to match,'' i.e.~it accept all possible \abbr{IP} addresses.

The second column lists the \emph{gateway} or router to which to send the packets destined for remote networks.
Only the default route has a gateway listed, which is also sometimes called the \emph{gateway of last resort}.
The other networks are known the the computer as it has an interface in that network so there is no need for a gateway.

We will skip the flags.
You can look those up in the documentation.
Finally the last column lists the interface from which to send the packets to their destination.

Now let's take a look at the first two entries, 0.0.0.0/0 and 10.18.0.0/16 and assume we want to send a packet destined to 10.18.20.7.
It matched the default route as all packets match this default, but it also matched the first sixteen bits of the 10.18.0.0 prefix.
Which route must it take then?
This brings us to the first important rule about routing tables:

\begin{quote}
   When selecting a route from the routing table, the longest match always wins.
\end{quote}

As the \abbr{IP} address matches the prefix 10.18.0.0/16 with sixteen bits and the prefix 0.0.0.0/0 with zero bits, the packet is sent out on the local network connected to vtnet0.
This happens to be the same interface as the default route is pointed out to but remember the \emph{address resolution protocol} (\abbr{ARP})!
When you send out traffic destined for a directly connected network you send out an \abbr{ARP} request for the destination \abbr{IP} address while when you need to forward the packet to a gateway, you send out an \abbr{ARP} request for that gateway's \abbr{MAC} address (see \vref{sec:arp}).

Before we move on to static routing, let's take a quick look at an example of a routing table on Windows~10.
Note that the command is not \cmd{netstat} but \cmd{route print}.

\begin{verbatim}
C:\>route print -4
\end{verbatim}




\section{Static routes}

Although I made them sound as something terrible and to-be avoided, static routes are very useful and are still used extensively in companies both small and large.
Somtimes there is only one way out and then it does not make sense to run a routing protocol.

Let's start with the example in \vref{fig:routing-home-network}.
The only way out for your home router is via the ISP router.
A simple static default route will thus suffice.
A \emph{default route} is the name given to the prefix 0.0.0.0/0 meaning that zero bits (due to the prefix length being zero) have to match the given prefix 0.0.0.0.
This matches all possible IP addresses.


\begin{figure}
   \centering
   Cloud -- ISP router -- home router -- local network (switch) with two computers
   \caption{Home router connecting your local network to the Internet}
   \label{fig:routing-home-network}
\end{figure}


\section{Router Information Protocol}

\section{Open Shortest Path First}

\section{Border Gateway Protocol}

