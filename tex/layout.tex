%\usepackage{geometry}
%\geometry{a4paper,top=30mm,bottom=65mm,left=30mm,right=65mm,footskip=30mm}
%\settypeblocksize{555pt}{*}{.617}
% s = w/8
%\setlrmargins{26.25mm}{*}{*}
%\setheadfoot{\baselineskip}{3\baselineskip}
%\setheaderspaces{*}{\baselineskip}{*}
%\setmarginnotes{2\baselineskip}{45mm}{.6\baselineskip}
%\checkandfixthelayout
\raggedbottom

\pagestyle{ruled}
\frenchspacing

% Bringhurst ToC
\renewcommand*{\cftchapterleader}{}
\renewcommand*{\cftsectionleader}{}
\renewcommand*{\cftsubsectionleader}{}
\renewcommand{\cftchapterpagefont}{}
\renewcommand*{\cftchapterformatpnum}[1]{\quad#1}
\renewcommand*{\cftsectionformatpnum}[1]{\quad#1}
\renewcommand*{\cftsubsectionformatpnum}[1]{\quad#1}
%\renewcommand*{\cftsubsectionformatpnum}[1]{~\quad\textbullet\quad#1}
\renewcommand{\cftchapterafterpnum}{\cftparfillskip}
\renewcommand{\cftsectionafterpnum}{\cftparfillskip}
\renewcommand{\cftsubsectionafterpnum}{\cftparfillskip}
\setrmarg{3.55em plus 1fil}
\setsecnumdepth{subsection}
\maxsecnumdepth{subsection}
\settocdepth{subsection}


% the chapter style:
% https://tex.stackexchange.com/a/88986
\usepackage{xcoffins}
\NewCoffin\main
\NewCoffin\titleline
\NewCoffin\chapternumber

\makechapterstyle{Bringhurst}{%
  \renewcommand*\chapterheadstart{}
  \renewcommand*\printchaptername{}
  \renewcommand*\chapternamenum{}
  \renewcommand*\afterchapternum{}
  % numbered chapters:
  \renewcommand*\printchapternum{%
      \SetHorizontalCoffin\chapternumber{%
      %\textcolor{black!10}{\thechapter}%
      \textcolor{spot1}{\thechapter}%
    }%
    \ScaleCoffin\chapternumber{8}{8}%
  }
  % unnumbered chapters:
  \renewcommand*\printchapternonum{\SetHorizontalCoffin\chapternumber{}}
  \renewcommand*\printchaptertitle[1]{%
    \memRTLraggedright\normalfont\large\MakeUppercase{\textls[75]{##1}}}
  \renewcommand*\afterchaptertitle{%
    \vskip.5\onelineskip
    \SetHorizontalCoffin\titleline{\color{black!50}\rule{\linewidth}{1.5pt}}%
    \JoinCoffins\main\titleline
    \JoinCoffins*\main\chapternumber(\textwidth+\marginparsep,-4\baselineskip)%
    \TypesetCoffin\main
    \vskip\onelineskip
  }
}

\chapterstyle{Bringhurst}

% sections and subsections:
\setsecnumformat{\normalfont\csname the#1\endcsname\quad}

% the section style:
\newcommand\uppercasehead[1]{%
  \noindent\normalfont\scshape\MakeLowercase{\textls[50]{#1}}}
\setsecindent{0pt}
\setsecheadstyle{\uppercasehead}

% the subsection style:
\newcommand\itshapehead[1]{\normalfont\itshape#1}
\setsubsecheadstyle{\itshapehead}
\setsecnumdepth{subsection}

% the subsubsection style:
\setsubsubsecheadstyle{\itshapehead}




% lists
\RequirePackage{enumitem}
\newlist{inlinelist}{enumerate*}{1}
\setlist*[inlinelist,1]{%
  label=(\roman*),
}
\firmlists
\renewcommand*{\descriptionlabel}[1]{\hspace\labelsep\scshape #1 --}

% Side notes
\strictpagechecktrue
\newcommand{\sidenote}[1]{%
    \checkoddpage%
    \ifoddpage%
    \marginpar{\begin{flushleft}\footnotesize#1\end{flushleft}}%
    \else%
    \marginpar{\begin{flushright}\footnotesize#1\end{flushright}}%
    \fi%
}

% Figures and tables
\usepackage{caption}
\DeclareCaptionLabelFormat{bringhurst}{\scshape\textls[50]{\MakeLowercase{#1}\,#2}}
\captionsetup{font={sf,small},labelformat=bringhurst,format=hang}



\newcommand*{\abbr}[1]{%
   % Format abbreviations as small capitals
   \texorpdfstring{\textsc{\MakeLowercase{#1}}}{#1}%
}
\newcommand{\hostname}[1]{\texttt{#1}}